@page "/perfil"
<NavBar />
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>Olá, <span id="user-name">Usuário</span></h1>
                <div class="notification-only"></div>
            </div>
        </header>

        <div class="profile-page-container">
            <!-- Menu Lateral -->
            <div class="sidebar-menu">
                <div class="profile-image-container">
                    <div class="edit-image-overlay" id="edit-image-overlay">
                        <button class="edit-image-btn" onclick="selecionarImagem()">Editar</button>
                        <input type="file" id="input-imagem" style="display: none;" accept="image/*" />
                    </div>
                </div>
                <div class="user-info">
                    <h3 id="sidebar-name">Nome do Usuário</h3>
                    <p id="sidebar-email">usuario@email.com</p>
                </div>
                <ul class="menu-options">
                    <li class="menu-item active" data-section="perfil" onclick="trocarSecao('perfil')">Perfil</li>
                    <li class="menu-item" data-section="editar-perfil" onclick="trocarSecao('editar-perfil')">Editar Perfil</li>
                    <li class="menu-item" data-section="meus-produtos" onclick="trocarSecao('meus-produtos')">Meus Produtos</li>
                </ul>
            </div>

            <!-- Conteúdo Principal -->
            <div class="main-content">
                <div class="content-section active" id="perfil-section">
                    <h2 class="section-title">Meu Perfil</h2>
                    <div class="profile-info-card">
                        <div class="info-row">
                            <label>Nome completo:</label>
                            <p id="info-nome-completo">-</p>
                        </div>
                        <div class="info-row">
                            <label>CPF:</label>
                            <p id="info-cpf">-</p>
                        </div>
                        <div class="info-row">
                            <label>Telefone:</label>
                            <p id="info-phone">-</p>
                        </div>
                        <div class="info-row">
                            <label>E-mail:</label>
                            <p id="info-email">-</p>
                        </div>
                    </div>
                </div>

                <div class="content-section" id="editar-perfil-section">
                    <h2 class="section-title">Editar Perfil</h2>
                    <div class="profile-form">
                        <div class="form-group">
                            <label for="nome-completo">Nome completo</label>
                            <input type="text" id="nome-completo" placeholder="Seu nome completo" />
                        </div>

                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" disabled class="input-disabled" />
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefone</label>
                            <input type="text" id="phone" placeholder="Seu telefone" />
                        </div>

                        <div class="form-group">
                            <label for="email-text">E-mail</label>
                            <input type="text" id="email-text" disabled class="input-disabled" />
                        </div>

                        <div class="form-group">
                            <label for="input-imagem-edicao">Nova imagem de perfil</label>
                            <input type="file" id="input-imagem-edicao" accept="image/*" />
                        </div>

                        <div class="form-actions">
                            <button class="save-button" onclick="salvarAlteracoes()">Salvar alterações</button>
                            <button class="cancel-button" onclick="cancelarEdicao()">Cancelar</button>
                        </div>
                    </div>
                </div>

                <div class="content-section" id="meus-produtos-section">
                    <h2 class="section-title">Meus Produtos</h2>
                    <div id="lista-produtos" class="produtos-grid"></div>
                </div>
            </div>
        </div>
    </div>
</body>
<Footer />

<script>
let dadosUsuario = {};
let produtosDoUsuario = [];

document.addEventListener("DOMContentLoaded", carregarPerfil);

async function carregarPerfil() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    if (!token) return;

    try {
        const payload = decodeJwt(token);
        const response = await fetch("https://api.anunciapicos.shop/profile/perfil", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        dadosUsuario = data;
        produtosDoUsuario = data.products || [];

        atualizarDadosInterface(data);
        carregarProdutos();

    } catch (error) {
        console.error("Erro ao carregar perfil:", error);
    }
}

function atualizarDadosInterface(data) {
    document.getElementById("user-name").textContent = data.name || "Usuário";
    document.getElementById("sidebar-name").textContent = data.name;
    document.getElementById("sidebar-email").textContent = data.email;
    document.getElementById("info-nome-completo").textContent = data.name;
    document.getElementById("info-cpf").textContent = data.cpf;
    document.getElementById("info-phone").textContent = data.phone;
    document.getElementById("info-email").textContent = data.email;
    document.getElementById("nome-completo").value = data.name;
    document.getElementById("cpf").value = data.cpf;
    document.getElementById("phone").value = data.phone;
    document.getElementById("email-text").value = data.email;

    if (data.imageProfile) {
        const container = document.querySelector(".profile-image-container");
        container.innerHTML = ""; // Limpa a imagem antiga

        const img = document.createElement("img");
        img.src = data.imageProfile;
        img.alt = "Imagem de perfil";
        Object.assign(img.style, {
            width: "100%", height: "100%",
            borderRadius: "50%", objectFit: "cover",
            position: "absolute", top: "0", left: "0"
        });
        container.appendChild(img);  // Adiciona a imagem

        const overlay = document.getElementById("edit-image-overlay");
        if (overlay) { // Verifica se o overlay existe
            // Remove o overlay anterior, se houver
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
            container.appendChild(overlay);  // Adiciona o overlay novamente
        }
    }
}


function carregarProdutos() {
    const lista = document.getElementById("lista-produtos");
    lista.innerHTML = "";

    // Extrai o token da URL ou de onde ele estiver armazenado
    const token = localStorage.getItem("token") || new URLSearchParams(window.location.search).get("token");
    
    if (!token) {
        console.error("Token não encontrado.");
        return;
    }

    // Decodificando o token para obter o ID (isso pode ser feito usando uma biblioteca como jwt-decode)
    const decodedToken = JSON.parse(atob(token.split('.')[1]));
    const userId = decodedToken.sub; // Aqui você pega o 'sub', que é o ID do usuário

    // Realiza a requisição para obter os produtos
    fetch(`https://api.anunciapicos.shop/produtos?userId=${userId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(produtos => {
        if (!produtos.length) {
            lista.innerHTML = "<p class='no-products'>Você ainda não tem produtos cadastrados.</p>";
            return;
        }

        // Popula a lista de produtos
        produtos.forEach(produto => {
            const imagem = produto.imageUrl?.[0] || "";
            const card = document.createElement("div");
            card.className = "produto-card";
            card.innerHTML = `
                ${imagem ? `<div class="produto-imagem"><img src="${imagem}" alt="${produto.name}" /></div>` : '<div class="produto-sem-imagem"></div>'}
                <div class="produto-info">
                    <h4>${produto.name}</h4>
                    <p>${produto.description}</p>
                    <strong class="produto-preco">R$ ${produto.price.toFixed(2)}</strong>
                </div>`;
            lista.appendChild(card);
        });
    })
    .catch(error => {
        console.error("Erro ao carregar produtos:", error);
        lista.innerHTML = "<p class='error'>Erro ao carregar produtos. Tente novamente mais tarde.</p>";
    });
}


function trocarSecao(secaoId) {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.menu-item[data-section="${secaoId}"]`).classList.add('active');
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(`${secaoId}-section`).classList.add('active');
}

function selecionarImagem() {
    document.getElementById("input-imagem-edicao").click();
}

function cancelarEdicao() {
    atualizarDadosInterface(dadosUsuario);
    trocarSecao('perfil');
}

async function salvarAlteracoes() {
    const nome = document.getElementById("nome-completo").value;
    const telefone = document.getElementById("phone").value;
    const email = document.getElementById("email-text").value;

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    const formData = new FormData();
    formData.append("name", nome);
    formData.append("email", email);
    formData.append("phone", telefone);

    const imagemInput = document.getElementById("input-imagem-edicao");
    if (imagemInput && imagemInput.files.length > 0) {
        const imagemFile = imagemInput.files[0];
        formData.append("imageProfile", imagemFile);
    }

    try {
        const response = await fetch("https://api.anunciapicos.shop/profile/atualizar-perfil", {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

        alert("Alterações salvas com sucesso!");
        await carregarPerfil();
        trocarSecao('perfil');

    } catch (error) {
        console.error("Erro detalhado:", error);
        alert("Falha ao salvar alterações: " + error.message);
    }
}

function decodeJwt(token) {
    const payload = token.split('.')[1];
    const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
    return JSON.parse(decoded);
}
</script>
