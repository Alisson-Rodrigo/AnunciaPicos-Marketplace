@page "/perfil"
<NavBar />
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>Olá, <span id="user-name">Usuário</span></h1>
                <div class="notification-only"></div>
            </div>
        </header>

        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-image-container">
                    
                    <div class="edit-image-overlay">
                        <button class="edit-image-btn">Editar</button>
                    </div>
                </div>
                <div class="profile-info">
                    <h2 id="display-name">Nome do Usuário</h2>
                    <p id="display-email">usuario@email.com</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="edit-btn" onclick="habilitarEdicao()">Editar perfil</button>
                        <button class="edit-btn" onclick="mostrarProdutos()">Mostrar meus produtos</button>
                    </div>
                </div>
            </div>

            <div class="profile-form">
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="nome-completo">Nome completo</label>
                        <input type="text" id="nome-completo" placeholder="Seu nome completo" disabled />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" placeholder="Seu CPF" disabled />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="phone">Telefone</label>
                        <input type="text" id="phone" placeholder="Seu telefone" disabled />
                    </div>
                </div>

                <div class="form-section">
                    <h3>Endereço de e-mail:</h3>
                    <div class="email-item">
                        <div class="email-radio">
                            <input type="radio" name="email-principal" id="email-1" checked />
                            <label for="email-1" class="email-label">
                                <span class="email-text" id="email-text">usuario@email.com</span>
                                <span class="email-date">1 mês atrás</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de produtos -->
            <div id="produtos-container" style="margin-top: 30px; display: none;">
                <h2>Meus Produtos</h2>
                <div id="lista-produtos" style="display: grid; gap: 15px;"></div>
            </div>
        </div>
    </div>
<Footer /> 
    <script>

    let produtosVisiveis = false;

    async function carregarPerfil() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token"); // Agora pega o token da URL

        if (!token) {
            console.error("Token não encontrado na URL. Usuário não autenticado.");
            return;
        }

        try {
            const response = await fetch("https://api.anunciapicos.shop/profile/perfil", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();

            // Preenche informações do perfil
            document.getElementById("user-name").textContent = data.name || "Usuário";
            document.getElementById("display-name").textContent = data.name || "Nome do Usuário";
            document.getElementById("display-email").textContent = data.email || "Email";
            document.getElementById("email-text").textContent = data.email || "Email";

            document.getElementById("nome-completo").value = data.name || "";
            document.getElementById("cpf").value = data.cpf || "";
            document.getElementById("phone").value = data.phone || "";

            if (data.imageProfile) {
                document.getElementById("profile-image").src = data.imageProfile;
            }

            // Salva os produtos na memória para exibição futura
            window.produtosDoUsuario = data.products || [];

        } catch (error) {
            console.error("Erro ao carregar perfil:", error);
        }
    }

    function habilitarEdicao() {
        document.getElementById("nome-completo").disabled = false;
        document.getElementById("cpf").disabled = false;
        document.getElementById("phone").disabled = false;
    }

    function mostrarProdutos() {
        const container = document.getElementById("produtos-container");
        const lista = document.getElementById("lista-produtos");

        if (!produtosVisiveis) {
            lista.innerHTML = "";

            if (!window.produtosDoUsuario || window.produtosDoUsuario.length === 0) {
                lista.innerHTML = "<p>Você ainda não tem produtos cadastrados.</p>";
            } else {
                window.produtosDoUsuario.forEach(produto => {
                    const imagem = produto.imageUrl?.[0] || "";

                    const card = `
                        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            ${imagem ? `<img src="${imagem}" alt="${produto.name}" style="width: 100px; height: 100px; object-fit: cover;" />` : ""}
                            <h4>${produto.name}</h4>
                            <p>${produto.description}</p>
                            <strong>R$ ${produto.price.toFixed(2)}</strong>
                        </div>
                    `;
                    lista.innerHTML += card;
                });
            }

            container.style.display = "block";
            produtosVisiveis = true;
        } else {
            container.style.display = "none";
            produtosVisiveis = false;
        }
    }

    // Carrega o perfil automaticamente ao carregar a página
    window.onload = carregarPerfil;
</script>

</body>
